<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="shortcut icon" type="image/jpeg" href="{{ '/assets/images/skull.jpg' | relative_url }}">
    <link rel="icon" type="image/jpeg" href="{{ '/assets/images/skull.jpg' | relative_url }}">
</head>
<body>
    <div class="matrix-bg"></div>
    
    <header class="site-header">
        <div class="container">
            <div class="skull-logo">
                <img src="{{ '/assets/images/skull.jpg' | relative_url }}" alt="Skull" />
            </div>
            <h1 class="site-title"><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
            <p class="site-description">{{ site.description }}</p>
            {% if page.layout == 'post' %}
            <nav class="site-nav">
                <a href="{{ '/' | relative_url }}" class="nav-link">home</a>
            </nav>
            {% endif %}
        </div>
    </header>

    <main class="site-content">
        <div class="global-layout">
            <div class="main-content-area">
                {% if page.layout == 'post' %}
                    {{ content }}
                {% else %}
                    <div class="container">
                        {{ content }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Global Search Sidebar -->
            <aside class="global-search-sidebar">
                <div class="search-wrapper">
                    <div class="search-title">Search Posts</div>
                    
                    <!-- Search Input -->
                    <div class="search-input-wrapper">
                        <input type="text" id="global-post-search" class="search-input" placeholder="Search posts..." />
                    </div>
                    
                    <!-- Tag Filter -->
                    <div class="tag-filter-section">
                        <div class="tag-filter-title">Filter by Tag</div>
                        <div id="global-tag-list" class="tag-list"></div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="global-search-results" class="search-results"></div>
                </div>
            </aside>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; {{ 'now' | date: "%Y" }} {{ site.author }}
        </div>
    </footer>

    <script src="{{ '/assets/js/main.js' | relative_url }}"></script>
    
    <script>
    // Global Search Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const posts = [
            {% for post in site.posts %}
            {
                title: {{ post.title | jsonify }},
                url: {{ post.url | relative_url | jsonify }},
                date: {{ post.date | date: "%B %d, %Y" | jsonify }},
                tags: {{ post.tags | jsonify }},
                excerpt: {{ post.excerpt | strip_html | truncatewords: 30 | jsonify }}
            }{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ];
        
        const searchInput = document.getElementById('global-post-search');
        const tagList = document.getElementById('global-tag-list');
        const searchResults = document.getElementById('global-search-results');
        
        if (!searchInput || !tagList || !searchResults) return;
        
        // Extract all unique tags
        const allTags = new Set();
        posts.forEach(post => {
            if (post.tags) post.tags.forEach(tag => allTags.add(tag));
        });
        
        // Create tag buttons
        const sortedTags = Array.from(allTags).sort();
        let activeTags = new Set();
        
        sortedTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'tag-btn';
            tagBtn.textContent = tag;
            tagBtn.addEventListener('click', () => {
                if (activeTags.has(tag)) {
                    activeTags.delete(tag);
                    tagBtn.classList.remove('active');
                } else {
                    activeTags.add(tag);
                    tagBtn.classList.add('active');
                }
                filterPosts();
            });
            tagList.appendChild(tagBtn);
        });
        
        // Fuzzy search function
        function fuzzyMatch(str, pattern) {
            str = str.toLowerCase();
            pattern = pattern.toLowerCase();
            let patternIdx = 0;
            
            for (let i = 0; i < str.length; i++) {
                if (str[i] === pattern[patternIdx]) {
                    patternIdx++;
                }
                if (patternIdx === pattern.length) return true;
            }
            return patternIdx === pattern.length;
        }
        
        // Filter and display posts
        function filterPosts() {
            const searchTerm = searchInput.value.trim();
            let filteredPosts = posts;
            
            // Apply search filter
            if (searchTerm) {
                filteredPosts = filteredPosts.filter(post => fuzzyMatch(post.title, searchTerm));
            }
            
            // Apply tag filter
            if (activeTags.size > 0) {
                filteredPosts = filteredPosts.filter(post => 
                    post.tags && post.tags.some(tag => activeTags.has(tag))
                );
            }
            
            // Display results
            if (searchTerm || activeTags.size > 0) {
                displayResults(filteredPosts);
            } else {
                searchResults.innerHTML = '';
            }
        }
        
        function displayResults(posts) {
            if (posts.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No posts found</div>';
                return;
            }
            
            let html = '<div class="results-header">' + posts.length + ' post' + (posts.length !== 1 ? 's' : '') + ' found</div>';
            html += '<ul class="results-list">';
            
            posts.forEach(post => {
                html += `
                    <li class="result-item">
                        <a href="${post.url}" class="result-link">
                            <div class="result-title">${post.title}</div>
                            <div class="result-date">${post.date}</div>
                        </a>
                    </li>
                `;
            });
            
            html += '</ul>';
            searchResults.innerHTML = html;
        }
        
        // Search input handler
        searchInput.addEventListener('input', filterPosts);
    });
    </script>
</body>
</html>
